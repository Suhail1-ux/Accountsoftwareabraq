@using AbraqAccount.Models
@using AbraqAccount.Services.Interfaces
@inject IPurchaseMasterService PurchaseService
@inject NavigationManager Navigation

<div class="form-card">
    <div class="form-header">
        <h3>@(IsEdit ? "Edit" : "Add") Purchase Item</h3>
        <div class="header-actions">
            @if (IsEdit)
            {
                <span class="badge bg-info me-3">Code: @model.Code</span>
            }
            <button class="btn btn-primary" @onclick="SubmitForm" disabled="@isSubmitting">
                @if (isSubmitting)
                {
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                }
                Save
            </button>
            <button class="btn btn-secondary" @onclick="Cancel">Cancel</button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    <div class="row g-3">
        <div class="col-md-6">
            <div class="form-group mb-3">
                <label class="form-label">Inventory Type</label>
                <select @bind="model.InventoryType" class="form-select">
                    <option value="Packing Inventory">Packing Inventory</option>
                    <option value="Storage Inventory">Storage Inventory</option>
                </select>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group mb-3">
                <label class="form-label text-danger">Inventory Item Group *</label>
                <select @bind="model.PurchaseItemGroupId" class="form-select">
                    <option value="0">--- Select Item Group ---</option>
                    @if (itemGroups != null)
                    {
                        @foreach (var group in itemGroups)
                        {
                            <option value="@group.Id">@group.Name</option>
                        }
                    }
                </select>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-md-6">
            <div class="form-group mb-3">
                <label class="form-label text-danger">Inventory Item Name *</label>
                <input type="text" @bind="model.ItemName" class="form-control" placeholder="Item Name" />
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group mb-3">
                <label class="form-label">Inventory Billing Name</label>
                <input type="text" @bind="model.BillingName" class="form-control" placeholder="Billing Name" />
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-md-4">
            <div class="form-group mb-3">
                <label class="form-label text-danger">UOM *</label>
                <select @bind="model.UOM" class="form-select">
                    <option value="">--- Select UOM ---</option>
                    <option value="Pieces">Pieces</option>
                    <option value="Number">Number</option>
                    <option value="Kg">Kg</option>
                    <option value="Gram">Gram</option>
                    <option value="Liter">Liter</option>
                    <option value="Meter">Meter</option>
                    <option value="Box">Box</option>
                    <option value="Carton">Carton</option>
                </select>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group mb-3">
                <label class="form-label">Minimum Stock</label>
                <input type="number" step="0.01" @bind="model.MinimumStock" class="form-control text-end" />
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group mb-3">
                <label class="form-label">Maximum Stock</label>
                <input type="number" step="0.01" @bind="model.MaximumStock" class="form-control text-end" />
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-md-4">
            <div class="form-group mb-3">
                <label class="form-label text-danger">Purchase Costing Per Nos. *</label>
                <input type="number" step="0.01" @bind="model.PurchaseCostingPerNos" class="form-control text-end" />
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group mb-3">
                <label class="form-label">Sale Costing Per Nos.</label>
                <input type="number" step="0.01" @bind="model.SaleCostingPerNos" class="form-control text-end" />
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group mb-3">
                <label class="form-label text-danger">GST(%) *</label>
                <select @bind="model.GST" class="form-select">
                    <option value="NA">NA</option>
                    <option value="0">0%</option>
                    <option value="5">5%</option>
                    <option value="12">12%</option>
                    <option value="18">18%</option>
                    <option value="28">28%</option>
                </select>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="form-group mb-3">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" @bind="model.IsActive" id="activeSwitch">
                    <label class="form-check-label" for="activeSwitch">Status (Active/Inactive)</label>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .form-card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); }
    .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid #eee; }
</style>

@code {
    [Parameter] public int? Id { get; set; }
    private PurchaseItem model = new() { IsActive = true, CreatedAt = DateTime.Now, InventoryType = "Packing Inventory", GST = "NA" };
    private List<PurchaseItemGroup>? itemGroups;
    private bool IsEdit => Id.HasValue;
    private bool isSubmitting;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        itemGroups = await PurchaseService.GetPurchaseItemGroupsAsync(null);

        if (IsEdit)
        {
            var existing = await PurchaseService.GetPurchaseItemByIdAsync(Id!.Value);
            if (existing != null)
            {
                model = existing;
            }
            else
            {
                errorMessage = "Item not found.";
            }
        }
    }

    private async Task SubmitForm()
    {
        if (model.PurchaseItemGroupId == 0) { errorMessage = "Item Group is required."; return; }
        if (string.IsNullOrWhiteSpace(model.ItemName)) { errorMessage = "Item Name is required."; return; }
        if (string.IsNullOrWhiteSpace(model.UOM)) { errorMessage = "UOM is required."; return; }

        isSubmitting = true;
        errorMessage = null;

        var user = "Admin"; // Hardcoded
        var result = IsEdit 
            ? await PurchaseService.UpdatePurchaseItemAsync(Id!.Value, model, user)
            : await PurchaseService.CreatePurchaseItemAsync(model, user);

        if (result.success)
        {
            Navigation.NavigateTo("/inventory/items");
        }
        else
        {
            errorMessage = result.message;
        }
        isSubmitting = false;
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/inventory/items");
    }
}
