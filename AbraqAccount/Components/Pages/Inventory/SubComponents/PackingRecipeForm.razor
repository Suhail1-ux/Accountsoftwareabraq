@using AbraqAccount.Models
@using AbraqAccount.Services.Interfaces
@using Microsoft.AspNetCore.Mvc.Rendering
@inject IPackingService PackingService
@inject NavigationManager Navigation

<div class="form-card">
    <div class="form-header">
        <h3>@(IsEdit ? "Edit" : "Add") Packing Recipe</h3>
        <div class="header-actions">
            @if (IsEdit)
            {
                <span class="badge bg-info me-3">Code: @model.RecipeCode</span>
            }
            <button class="btn btn-primary" @onclick="SubmitForm" disabled="@isSubmitting">
                @if (isSubmitting)
                {
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                }
                Save
            </button>
            <button class="btn btn-secondary" @onclick="Cancel">Cancel</button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    <div class="row g-3">
        <div class="col-md-4">
            <div class="form-group mb-3">
                <label class="form-label text-danger">Recipe Name *</label>
                <input type="text" @bind="model.RecipeName" class="form-control" placeholder="Enter recipe name..." />
            </div>
        </div>
        <div class="col-md-2">
            <div class="form-group mb-3">
                <label class="form-label text-danger">UOM *</label>
                <select @bind="model.RecipeUOMName" class="form-select">
                    <option value="">-- Select --</option>
                    @if (uomOptions != null)
                    {
                        @foreach (var opt in uomOptions)
                        {
                            <option value="@opt.Value">@opt.Text</option>
                        }
                    }
                </select>
            </div>
        </div>
        <div class="col-md-2">
            <div class="form-group mb-3">
                <label class="form-label text-danger">Cost Unit *</label>
                <input type="number" step="0.01" @bind="model.CostUnit" class="form-control text-end" />
            </div>
        </div>
        <div class="col-md-2">
            <div class="form-group mb-3">
                <label class="form-label text-danger">Labour Cost *</label>
                <input type="number" step="0.01" @bind="model.LabourCost" class="form-control text-end" />
            </div>
        </div>
        <div class="col-md-2">
            <div class="form-group mb-3">
                <label class="form-label">Status</label>
                <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" @bind="model.IsActive" id="activeSwitch">
                    <label class="form-check-label" for="activeSwitch">@(model.IsActive ? "Active" : "Inactive")</label>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="form-group mb-3">
                <label class="form-label">High Density Rate</label>
                <input type="number" step="0.01" @bind="model.HighDensityRate" class="form-control text-end" />
            </div>
        </div>
    </div>

    <div class="materials-section mt-4">
        <h5>Recipe Materials</h5>
        <div class="table-responsive">
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Material Item</th>
                        <th style="width: 100px;">UOM</th>
                        <th style="width: 120px;">Qty</th>
                        <th style="width: 150px;">Value</th>
                        <th style="width: 40px;"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var mat in model.Materials)
                    {
                        <tr>
                            <td class="position-static" style="min-width: 300px;">
                                <AbraqAccount.Components.Common.AccountSearch 
                                    Placeholder="Search Material..." 
                                    SearchFunc='(term) => PackingService.GetPackingMaterialsAsync(term)'
                                    OnAccountSelected="(acc) => OnMaterialSelected(mat, acc)"
                                    InitialValue="@mat.PurchaseItem?.ItemName" />
                            </td>
                            <td><input type="text" @bind="mat.UOM" class="form-control form-control-sm" disabled /></td>
                            <td><input type="number" step="0.0001" value="@mat.Qty" @oninput="(e) => UpdateMaterial(mat, e, 'Q')" class="form-control form-control-sm text-end" /></td>
                            <td><input type="number" step="0.01" value="@mat.Value" @oninput="(e) => UpdateMaterial(mat, e, 'V')" class="form-control form-control-sm text-end" /></td>
                            <td>
                                <button class="btn btn-outline-danger btn-sm p-0 px-1" @onclick="() => model.Materials.Remove(mat)">
                                    <i class="bi bi-dash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <button class="btn btn-outline-primary btn-sm" @onclick="AddMaterial">
            <i class="bi bi-plus"></i> Add Material
        </button>
    </div>

    <div class="footer-summary mt-4 p-3 bg-light rounded text-end">
        <span class="h5">Total Value: <span class="text-primary">@TotalValue.ToString("N2")</span></span>
    </div>
</div>

<style>
    .form-card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); }
    .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid #eee; }
</style>

@code {
    [Parameter] public int? Id { get; set; }
    private PackingRecipe model = new() { IsActive = true, CreatedAt = DateTime.Now, CostUnit = 1 };
    private List<SelectListItem>? uomOptions;
    private bool IsEdit => Id.HasValue;
    private bool isSubmitting;
    private string? errorMessage;

    private decimal TotalValue => model.Materials.Sum(m => m.Value);

    protected override async Task OnInitializedAsync()
    {
        dynamic viewBag = new System.Dynamic.ExpandoObject();
        await PackingService.LoadRecipeDropdownsAsync(viewBag);
        uomOptions = ((SelectList)viewBag.RecipeUOMName).ToList();

        if (IsEdit)
        {
            var existing = await PackingService.GetPackingRecipeByIdAsync(Id!.Value);
            if (existing != null)
            {
                model = existing;
            }
            else
            {
                errorMessage = "Recipe not found.";
            }
        }
        else
        {
            AddMaterial();
        }
    }

    private void AddMaterial() => model.Materials.Add(new PackingRecipeMaterial { CreatedAt = DateTime.Now });

    private void OnMaterialSelected(PackingRecipeMaterial mat, LookupItem lookup)
    {
        mat.PurchaseItemId = lookup.Id;
        mat.PurchaseItem = new PurchaseItem { Id = lookup.Id, ItemName = lookup.Name };
        mat.UOM = lookup.UOM ?? "";
    }

    private void UpdateMaterial(PackingRecipeMaterial mat, ChangeEventArgs e, char field)
    {
        if (decimal.TryParse(e.Value?.ToString(), out decimal val))
        {
            if (field == 'Q') mat.Qty = val;
            else if (field == 'V') mat.Value = val;
        }
    }

    private async Task SubmitForm()
    {
        if (string.IsNullOrWhiteSpace(model.RecipeName)) { errorMessage = "Recipe Name is required."; return; }
        if (string.IsNullOrWhiteSpace(model.RecipeUOMName)) { errorMessage = "UOM is required."; return; }

        isSubmitting = true;
        errorMessage = null;

        model.Value = TotalValue;

        var result = IsEdit 
            ? await PackingService.UpdatePackingRecipeAsync(Id!.Value, model, model.Materials)
            : await CreateRecipeWorkaround();

        if (result.success)
        {
            Navigation.NavigateTo("/inventory/packing-recipes");
        }
        else
        {
            errorMessage = result.message;
        }
        isSubmitting = false;
    }

    private async Task<(bool success, string message)> CreateRecipeWorkaround()
    {
        // PackingService.CreatePackingRecipeAsync takes IFormCollection. 
        // I should probably add a clean Create method to IPackingService.
        // For now, I'll update the implementation to have a clean version or I'll hack it.
        // Let's just use Update with 0 if it handles it, or I'll add the method.
        return await PackingService.UpdatePackingRecipeAsync(0, model, model.Materials);
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/inventory/packing-recipes");
    }
}
