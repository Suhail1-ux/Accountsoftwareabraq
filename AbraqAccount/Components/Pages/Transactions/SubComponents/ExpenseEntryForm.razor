@using AbraqAccount.Models
@using AbraqAccount.Services.Interfaces
@inject IExpensesIncurredService ExpenseService
@inject NavigationManager Navigation
@inject INotificationService NotificationService

<div class="expense-entry-container">
    <!-- Header with Breadcrumbs and Top Actions -->
    <div class="expense-header">
        <div class="expense-title-section">
            <h1>Expense Entry <small class="subtitle" style="color: #999; font-size: 0.9rem; font-weight: normal;">Control panel</small></h1>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <div class="breadcrumbs-top">
                <i class="bi bi-house"></i> Home <span>&gt;</span> Expense Entry
            </div>
            <div class="header-actions">
                @if (!IsReadOnly)
                {
                    <button class="btn btn-save-custom px-4" @onclick="SubmitForm" disabled="@isSubmitting">
                        @if (isSubmitting) { <span class="spinner-border spinner-border-sm me-2"></span> }
                        <i class="bi bi-save2-fill me-2"></i> Save
                    </button>
                    @* <button type="button" class="add-button-header" @onclick="ClearNewItem" title="New Entry">
                        <i class="bi bi-plus-lg"></i>
                    </button> *@
                }
                <button class="btn btn-back-custom" @onclick="Cancel" title="Back"><i class="bi bi-arrow-left"></i></button>
            </div>
        </div>
    </div>

    <!-- Main Form Section -->
    <fieldset disabled="@IsReadOnly">
        <div class="card shadow-sm border-0 mb-5 modern-card">
            <div class="card-header modern-header py-3 px-4">
                <h5 class="mb-0 fw-700">Basic Information <small class="text-muted fw-normal ms-2">â€” @(IsReadOnly ? "View Mode" : (IsEdit ? "Update Entry" : "New Entry"))</small></h5>
            </div>
            <div class="card-body p-4 p-lg-5">
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger border-0 shadow-sm py-3 px-4 mb-4" style="font-size: 0.9rem; border-radius: 12px;">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> @errorMessage
                    </div>
                }

                <div class="modern-input-row">
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label-modern">Received Date <span class="text-danger">*</span></label>
                            <input type="date" @bind="model.ExpenseDate" class="form-control-modern" />
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label-modern">Credit Account <span class="text-danger">*</span></label>
                            <AbraqAccount.Components.Common.AccountSearch 
                                Placeholder="Search Credit Account" 
                                SearchFunc='@((s) => ExpenseService.GetAccountsAsync(s, "Credit"))'
                                OnAccountSelected="OnVendorSelected"
                                InitialValue="@model.VendorName"
                                CssClass="form-control-modern" />
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label-modern">Debit Account <span class="text-danger">*</span></label>
                            <AbraqAccount.Components.Common.AccountSearch 
                                Placeholder="Search Debit Account" 
                                SearchFunc='@((s) => ExpenseService.GetAccountsAsync(s, "Debit"))'
                                OnAccountSelected="OnDebitAccountSelected"
                                InitialValue="@model.DebitAccountName"
                                CssClass="form-control-modern" />
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label-modern">Unit <span class="text-danger">*</span></label>
                            <select @bind="model.Unit" class="form-control-modern">
                                <option value="">SELECT UNIT</option>
                                @foreach (var unit in unitList)
                                {
                                    <option value="@unit">@unit</option>
                                }
                            </select>
                        </div>

                        <div class="col-lg-3 col-md-6">
                            <label class="form-label-modern">PO Type <span class="text-danger">*</span></label>
                            <select @bind="model.POType" class="form-control-modern">
                                <option value="">SELECT</option>
                                <option value="PO">PO</option>
                                <option value="Non-PO">Non-PO</option>
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label-modern">Bill Date <span class="text-danger">*</span></label>
                            <input type="date" @bind="model.BillDate" class="form-control-modern" />
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label-modern">Bill No <span class="text-danger">*</span></label>
                            <input type="text" @bind="model.BillNo" class="form-control-modern" placeholder="Ref/Bill No" />
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label-modern">Vehicle No <span class="text-danger">*</span></label>
                            <select @bind="model.VehicleNo" class="form-control-modern">
                                <option value="">SELECT VEHICLE</option>
                                @foreach (var vehicle in vehicleList)
                                {
                                    <option value="@vehicle.VehNo">@vehicle.VehNo @(string.IsNullOrEmpty(vehicle.DriverName) ? "" : $"({vehicle.DriverName})")</option>
                                }
                            </select>
                        </div>

                        <div class="col-lg-3 col-md-6">
                            <label class="form-label-modern">PAN No</label>
                            <input type="text" @bind="model.PANNo" class="form-control-modern" placeholder="PAN No" />
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label-modern">Firm Type</label>
                            <input type="text" @bind="model.FirmType" class="form-control-modern" placeholder="Firm Type" />
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label-modern">Expense ledger <span class="text-danger">*</span></label>
                            <AbraqAccount.Components.Common.AccountSearch 
                                Placeholder="Search Ledger" 
                                SearchFunc="@((s) => ExpenseService.GetExpenseLedgersAsync(null, s))"
                                OnAccountSelected="OnLedgerSelected"
                                InitialValue="@model.ExpenseLedger?.Name"
                                CssClass="form-control-modern" />
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label-modern">Bill File</label>
                            <div class="d-flex align-items-center gap-2">
                                <button class="btn btn-outline-secondary btn-xs-modern w-100" type="button" @onclick="() => {}">Upload</button>
                                <span class="text-muted x-small">None</span>
                            </div>
                        </div>

                        <div class="col-12 mt-1">
                            <label class="form-label-modern">Remarks</label>
                            <textarea @bind="model.Remarks" class="form-control-modern" rows="1" placeholder="Short Remarks (Optional)"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Items Section -->
        <div class="card shadow-sm border-0 mb-3 modern-card">
            <div class="card-header modern-header py-2 px-3 d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold">Items</h6>
            </div>
            <div class="card-body p-3">
                @if (!IsReadOnly)
                {
                    <div class="modern-input-row mb-3">
                        <div class="row g-2">
                            <div class="col-lg-3 col-md-6">
                                <label class="form-label-modern">Item Group <span class="text-danger">*</span></label>
                                <AbraqAccount.Components.Common.AccountSearch 
                                    Placeholder="Group" 
                                    SearchFunc="ExpenseService.GetItemGroupsAsync"
                                    OnAccountSelected="OnNewItemGroupSelected"
                                    InitialValue="@newItem.ItemGroup?.Name"
                                    CssClass="form-control-modern" />
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <label class="form-label-modern">Item Name <span class="text-danger">*</span></label>
                                <AbraqAccount.Components.Common.AccountSearch 
                                    Placeholder="Item" 
                                    SearchFunc="@((s) => ExpenseService.GetItemNamesAsync(newItem.ItemGroupId, s))"
                                    OnAccountSelected="OnNewItemNameSelected"
                                    InitialValue="@newItem.Item?.ItemName"
                                    CssClass="form-control-modern" />
                            </div>
                            <div class="col-lg-4 col-md-8">
                                <label class="form-label-modern">Description</label>
                                <input type="text" @bind="newItem.Description" class="form-control-modern" placeholder="Description" />
                            </div>
                            <div class="col-lg-2 col-md-4">
                                <label class="form-label-modern">UOM</label>
                                <input type="text" @bind="newItem.UOM" class="form-control-modern bg-light" readonly />
                            </div>

                            <div class="col-lg-1 col-md-2 col-4">
                                <label class="form-label-modern">Qty</label>
                                <input type="number" @bind="newItem.Qty" @oninput="(e) => UpdateNewItem(e, 'Q')" class="form-control-modern text-end" />
                            </div>
                            <div class="col-lg-2 col-md-3 col-4">
                                <label class="form-label-modern">Unit Price</label>
                                <input type="number" @bind="newItem.UnitPrice" @oninput="(e) => UpdateNewItem(e, 'P')" class="form-control-modern text-end" />
                            </div>
                            <div class="col-lg-2 col-md-3 col-4">
                                <label class="form-label-modern">Amount</label>
                                <input type="number" @bind="newItem.Amount" class="form-control-modern text-end bg-light" readonly />
                            </div>
                            <div class="col-lg-1 col-md-2 col-4">
                                <label class="form-label-modern">Disc.</label>
                                <input type="number" @bind="newItem.Discount" @oninput="(e) => UpdateNewItem(e, 'D')" class="form-control-modern text-end" />
                            </div>
                            <div class="col-lg-1 col-md-2 col-4">
                                <label class="form-label-modern">GST%</label>
                                <select value="@newItem.GST" @onchange='@((e) => { newItem.GST = e.Value?.ToString() ?? "NA"; UpdateNewItemCalculations(); })' class="form-control-modern p-1">
                                    <option value="NA">NA</option>
                                    <option value="5%">5%</option>
                                    <option value="12%">12%</option>
                                    <option value="18%">18%</option>
                                    <option value="28%">28%</option>
                                </select>
                            </div>
                            <div class="col-lg-2 col-md-3 col-4">
                                <label class="form-label-modern">GST Amt</label>
                                <input type="number" @bind="newItem.GSTAmount" class="form-control-modern text-end bg-light" readonly />
                            </div>
                            <div class="col-lg-2 col-md-4 col-12 d-flex align-items-end gap-1">
                                <button class="btn btn-modern-add w-100" @onclick="AddNewItemRow"><i class="bi bi-plus-lg"></i> Add</button>
                                <button class="btn btn-modern-cancel w-100" @onclick="ClearNewItem">Clear</button>
                            </div>
                        </div>
                    </div>
                }

                <div class="table-responsive">
                    <table class="table table-custom border">
                        <thead>
                            <tr>
                                <th>Item Group</th>
                                <th>Item Name</th>
                                <th class="text-end">Qty</th>
                                <th class="text-end">Unit Price</th>
                                <th class="text-end">Amount</th>
                                <th class="text-end">Total Amount</th>
                                @if (!IsReadOnly) { <th class="text-center">Action</th> }
                            </tr>
                        </thead>
                        <tbody>
                            @if (!model.Items.Any())
                            {
                                <tr><td colspan="@(IsReadOnly ? 6 : 7)" class="text-center py-4 text-danger fw-bold">No Items found!!</td></tr>
                            }
                            else
                            {
                                @foreach (var item in model.Items)
                                {
                                    <tr>
                                        <td>@item.ItemGroup?.Name</td>
                                        <td>@item.Item?.ItemName</td>
                                        <td class="text-end">@item.Qty</td>
                                        <td class="text-end">@item.UnitPrice.ToString("N3")</td>
                                        <td class="text-end">@item.Amount.ToString("N3")</td>
                                        <td class="text-end">@item.TotalAmount.ToString("N3")</td>
                                        @if (!IsReadOnly)
                                        {
                                            <td class="text-center">
                                                <button class="btn btn-link text-danger p-0" title="Delete" @onclick="() => model.Items.Remove(item)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        }
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Misc Charges Section -->
        <div class="card shadow-sm border-0 mb-3 modern-card">
            <div class="card-header modern-header py-2 px-3">
                <h6 class="mb-0 fw-bold">Miscellaneous Charges</h6>
            </div>
            <div class="card-body p-3">
                @if (!IsReadOnly)
                {
                    <div class="modern-input-row mb-3">
                        <div class="row g-2">
                            <div class="col-lg-4 col-md-6">
                                <label class="form-label-modern">Expense Type <span class="text-danger">*</span></label>
                                <input type="text" @bind="newMisc.ExpenseType" class="form-control-modern" placeholder="e.g. Freight, Packing" />
                            </div>
                            <div class="col-lg-3 col-md-3 col-6">
                                <label class="form-label-modern">Amount <span class="text-danger">*</span></label>
                                <input type="number" @bind="newMisc.Amount" @oninput="(e) => UpdateNewMisc(e, 'A')" class="form-control-modern text-end" />
                            </div>
                            <div class="col-lg-2 col-md-3 col-6">
                                <label class="form-label-modern">Tax(%)</label>
                                <select value="@newMisc.Tax" @onchange='@((e) => { newMisc.Tax = e.Value?.ToString() ?? "Select"; UpdateNewMiscCalculations(); })' class="form-control-modern">
                                    <option value="Select">Select</option>
                                    <option value="5%">5%</option>
                                    <option value="12%">12%</option>
                                    <option value="18%">18%</option>
                                    <option value="28%">28%</option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-12 d-flex align-items-end gap-1">
                                <button class="btn btn-modern-add w-100" @onclick="AddNewMiscRow"><i class="bi bi-plus-lg"></i> Add</button>
                                <button class="btn btn-modern-cancel w-100" @onclick="ClearNewMisc">Clear</button>
                            </div>
                        </div>
                    </div>
                }

                <div class="table-responsive">
                    <table class="table table-custom border">
                        <thead>
                            <tr>
                                <th>Expense Type</th>
                                <th class="text-end">Amount</th>
                                <th class="text-center">GST(%)</th>
                                <th class="text-end">GST Amount</th>
                                <th class="text-end">Total Amount</th>
                                @if (!IsReadOnly) { <th class="text-center">Action</th> }
                            </tr>
                        </thead>
                        <tbody>
                            @if (!model.MiscCharges.Any())
                            {
                                <tr><td colspan="@(IsReadOnly ? 5 : 6)" class="text-center py-4 text-danger fw-bold">No Miscellaneous Charges found!!</td></tr>
                            }
                            else
                            {
                                @foreach (var m in model.MiscCharges)
                                {
                                    <tr>
                                        <td>@m.ExpenseType</td>
                                        <td class="text-end">@m.Amount.ToString("N3")</td>
                                        <td class="text-center">@m.Tax</td>
                                        <td class="text-end">@m.GSTAmount.ToString("N3")</td>
                                        <td class="text-end">@m.TotalAmount.ToString("N3")</td>
                                        @if (!IsReadOnly)
                                        {
                                            <td class="text-center">
                                                <button class="btn btn-link text-danger p-0" title="Delete" @onclick="() => model.MiscCharges.Remove(m)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        }
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </fieldset>

    <!-- Sticky Totals Footer -->
    <div class="sticky-footer shadow">
        <div class="row align-items-center g-3">
            <div class="col-lg-3 col-md-6">
                <div class="total-box">
                    <span class="label">Gross Total</span>
                    <span class="value">@GrossAmount.ToString("N3")</span>
                </div>
            </div>
            <div class="col-lg-2 col-md-6">
                 <div class="total-box">
                    <span class="label">Discount</span>
                    <input type="number" @bind="model.TotalDiscount" @oninput="() => RecalculateTotals()" class="discount-input" readonly="@IsReadOnly" />
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                 <div class="total-box net-total">
                    <span class="label">Net Total</span>
                    <span class="value">@TotalAmount.ToString("N3")</span>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 d-flex justify-content-end gap-2">
                @if (!IsReadOnly)
                {
                    <button class="btn btn-modern-save px-4" @onclick="SubmitForm" disabled="@isSubmitting">
                        @if (isSubmitting) { <span class="spinner-border spinner-border-sm me-2"></span> }
                        <i class="bi bi-check-circle me-1"></i> Save Entry
                    </button>
                }
                <button class="btn btn-modern-back px-4" @onclick="Cancel">
                    <i class="bi @(IsReadOnly ? "bi-arrow-left" : "bi-x-circle") me-1"></i>
                    @(IsReadOnly ? "Back to List" : "Cancel")
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .expense-entry-container { padding: 0 2rem 120px 2rem; background: #f8fafc; font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    
    .expense-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding: 1.5rem 2rem;
        background-color: white;
        margin: -2rem -2rem 1.5rem -2rem;
        border-bottom: 1px solid #e0e0e0;
    }

    .expense-title-section h1 { font-size: 2rem; font-weight: bold; margin: 0; color: #333; }
    .breadcrumbs-top { font-size: 0.9rem; color: #666; margin-right: 1rem; }
    .breadcrumbs-top span { margin: 0 0.5rem; color: #999; }

    .header-actions { display: flex; gap: 0.5rem; align-items: center; }

    .btn-save-custom { 
        background-color: #6c757d; color: white; border: none; border-radius: 4px; padding: 0.5rem 1.5rem;
        font-weight: 500; font-size: 0.9rem; transition: background-color 0.2s;
    }
    .btn-save-custom:hover { background-color: #5a6268; }

    .add-button-header {
        width: 38px; height: 38px; background-color: #6c757d; border: none; border-radius: 4px;
        display: flex; align-items: center; justify-content: center; cursor: pointer;
        font-size: 1.1rem; color: white; transition: background-color 0.2s;
    }
    .add-button-header:hover { background-color: #5a6268; }

    .btn-back-custom { 
        background-color: #e9ecef; color: #495057; border: 1px solid #dee2e6; border-radius: 4px;
        width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; cursor: pointer;
        transition: all 0.2s;
    }
    .btn-back-custom:hover { background-color: #dee2e6; color: #212529; }

    .modern-card { border-radius: 8px; border: 1px solid #e0e0e0; background: #ffffff; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .modern-header { background: #fcfdfe; border-bottom: 1px solid #e0e0e0; padding: 10px 15px; }
    .modern-header h5, .modern-header h6 { color: #333; font-weight: 600; font-size: 0.95rem; margin-bottom: 0; }

    .form-label-modern { display: block; font-size: 0.7rem; font-weight: 800; color: #666; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; }
    .form-control-modern { border: 1px solid #ddd; border-radius: 4px; padding: 8px 12px; font-size: 0.875rem; width: 100%; transition: all 0.2s; background-color: #fcfdfe; }
    .form-control-modern:focus { border-color: #6c757d; outline: none; background-color: #fff; box-shadow: 0 0 0 3px rgba(108, 117, 125, 0.1); }
    .form-control-modern[readonly] { background-color: #f1f5f9; cursor: not-allowed; color: #666; }

    .modern-input-row { background: #f8fafc; padding: 12px; border: 1px solid #e0e0e0; border-radius: 6px; }

    .table-custom thead th { background: #f8fafc; color: #333; font-size: 0.7rem; text-transform: uppercase; font-weight: 700; padding: 12px; border-bottom: 2px solid #dee2e6; }
    .table-custom tbody td { padding: 10px; font-size: 0.8rem; vertical-align: middle; color: #444; border-bottom: 1px solid #eee; }
    .table-custom tbody tr:hover { background-color: #f8fafc; }

    .sticky-footer { position: fixed; bottom: 0; left: var(--sidebar-width); right: 0; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); padding: 12px 30px; border-top: 1px solid #dee2e6; z-index: 900; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
    /* Mobile adjustment */
    @@media (max-width: 991.98px) { .sticky-footer { left: 0; } }

    .total-box { display: flex; flex-direction: column; background: #fff; padding: 8px 15px; border: 1px solid #ddd; border-radius: 6px; }
    .total-box .label { font-size: 0.6rem; font-weight: 800; color: #666; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 2px; }
    .total-box .value { font-size: 1.1rem; font-weight: 700; color: #333; }
    
    .net-total { background: #f8f9fa; border-color: #dee2e6; }

    .discount-input { border: none; background: transparent; font-size: 1.1rem; font-weight: 700; color: #dc3545; text-align: right; width: 100%; outline: none; }

    .btn-modern-add { background: #28a745; color: white; border: none; border-radius: 4px; font-weight: 600; font-size: 0.875rem; transition: all 0.2s; padding: 8px; }
    .btn-modern-add:hover { background: #218838; }
    .btn-modern-cancel { background: #fff; color: #6c757d; border: 1px solid #ddd; border-radius: 4px; font-weight: 600; font-size: 0.875rem; padding: 8px; }
    
    .btn-modern-save { background: #6c757d; color: white; border: none; border-radius: 4px; font-weight: 600; font-size: 0.95rem; }
    .btn-modern-back { background: #fff; color: #6c757d; border: 1px solid #ddd; border-radius: 4px; font-weight: 600; font-size: 0.95rem; }

    .col-lg-2 { width: 16.666667%; }

    @@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .modern-card { animation: fadeIn 0.5s ease-out; }
</style>

@code {
    [Parameter] public int? Id { get; set; }
    [Parameter] public bool IsReadOnly { get; set; }
    private ExpensesIncurred model = new() { ExpenseDate = DateTime.Now, BillDate = DateTime.Now };
    private ExpenseItem newItem = new() { CreatedAt = DateTime.Now, GST = "NA" };
    private ExpenseMiscCharge newMisc = new() { CreatedAt = DateTime.Now, Tax = "Select" };
    
    // Data lists
    private List<string> unitList = new() { "Unit 1", "Unit 2", "Abraq Agro Fresh LLP" };
    private List<VehInfo> vehicleList = new();

    private bool IsEdit => Id.HasValue;
    private bool isSubmitting;
    private string? errorMessage;

    private decimal GrossAmount => model.Items.Sum(i => i.TotalAmount) + model.MiscCharges.Sum(m => m.TotalAmount);
    private decimal TotalAmount => GrossAmount - model.TotalDiscount;

    protected override async Task OnInitializedAsync()
    {
        vehicleList = (await ExpenseService.GetVehiclesListAsync()).ToList();

        if (IsEdit)
        {
            var exp = await ExpenseService.GetExpenseByIdAsync(Id!.Value, true, true);
            if (exp != null)
            {
                model = exp;
                if (model.Status == "Approved")
                {
                    IsReadOnly = true;
                }
            }
            else Navigation.NavigateTo("/transactions/expense-entry");
        }
    }

    // Handlers for Basic Info
    private void OnLedgerSelected(LookupItem lookup)
    {
        model.ExpenseLedgerId = lookup.Id;
        model.ExpenseLedger = new SubGroupLedger { Id = lookup.Id, Name = lookup.Name };
    }

    private void OnDebitAccountSelected(LookupItem lookup)
    {
        model.DebitAccountId = lookup.Id;
        model.DebitAccountName = lookup.Name;
    }

    private void OnVendorSelected(LookupItem lookup)
    {
        model.VendorId = lookup.Id;
        model.VendorName = lookup.Name;
    }

    // New Item logic
    private void OnNewItemGroupSelected(LookupItem lookup)
    {
        newItem.ItemGroupId = lookup.Id;
        newItem.ItemGroup = new PurchaseItemGroup { Id = lookup.Id, Name = lookup.Name };
    }

    private void OnNewItemNameSelected(LookupItem lookup)
    {
        newItem.ItemId = lookup.Id;
        newItem.Item = new PurchaseItem { Id = lookup.Id, ItemName = lookup.Name, UOM = lookup.UOM ?? "" };
        newItem.UOM = lookup.UOM ?? "";
    }

    private void UpdateNewItem(ChangeEventArgs e, char field)
    {
        if (decimal.TryParse(e.Value?.ToString(), out decimal val))
        {
            if (field == 'Q') newItem.Qty = val;
            else if (field == 'P') newItem.UnitPrice = val;
            else if (field == 'D') newItem.Discount = val;
            UpdateNewItemCalculations();
        }
    }

    private void UpdateNewItemCalculations()
    {
        newItem.Amount = newItem.Qty * newItem.UnitPrice;
        newItem.GSTAmount = CalculateTax(newItem.Amount - newItem.Discount, newItem.GST);
        newItem.TotalAmount = newItem.Amount - newItem.Discount + newItem.GSTAmount;
    }

    private void AddNewItemRow()
    {
        if (newItem.ItemId == 0 || newItem.Qty <= 0)
        {
            errorMessage = "Please select an item and enter quantity.";
            return;
        }
        model.Items.Add(newItem);
        ClearNewItem();
        errorMessage = null;
        RecalculateTotals();
    }

    private void ClearNewItem()
    {
        newItem = new ExpenseItem { CreatedAt = DateTime.Now, GST = "NA" };
    }

    // New Misc Charge logic
    private void UpdateNewMisc(ChangeEventArgs e, char field)
    {
        if (decimal.TryParse(e.Value?.ToString(), out decimal val))
        {
            if (field == 'A') newMisc.Amount = val;
            UpdateNewMiscCalculations();
        }
    }

    private void UpdateNewMiscCalculations()
    {
        newMisc.GSTAmount = CalculateTax(newMisc.Amount, newMisc.Tax);
        newMisc.TotalAmount = newMisc.Amount + newMisc.GSTAmount;
    }

    private void AddNewMiscRow()
    {
        if (string.IsNullOrEmpty(newMisc.ExpenseType) || newMisc.Amount <= 0)
        {
            errorMessage = "Please enter expense type and amount.";
            return;
        }
        model.MiscCharges.Add(newMisc);
        ClearNewMisc();
        errorMessage = null;
        RecalculateTotals();
    }

    private void ClearNewMisc()
    {
        newMisc = new ExpenseMiscCharge { CreatedAt = DateTime.Now, Tax = "Select" };
    }

    private decimal CalculateTax(decimal amount, string gst)
    {
        if (string.IsNullOrEmpty(gst) || gst == "NA" || gst == "Select") return 0;
        if (decimal.TryParse(gst.Replace("%", ""), out decimal rate))
        {
            return amount * (rate / 100);
        }
        return 0;
    }

    private void RecalculateTotals()
    {
        model.Amount = TotalAmount;
        StateHasChanged();
    }

    private async Task SubmitForm()
    {
        if (!model.ExpenseLedgerId.HasValue) { errorMessage = "Expense Ledger is required."; return; }
        if (!model.DebitAccountId.HasValue) { errorMessage = "Debit Account is required."; return; }
        if (model.VendorId == null) { errorMessage = "Credit Account is required."; return; }

        isSubmitting = true;
        errorMessage = null;

        model.Amount = TotalAmount;

        try
        {
            ExpensesIncurred result;
            if (IsEdit) result = await ExpenseService.UpdateExpenseAsync(Id!.Value, model);
            else result = await ExpenseService.CreateExpenseAsync(model);

            if (result != null)
            {
                NotificationService.ShowSuccess("Expense Entry saved successfully!");
                Navigation.NavigateTo("/transactions/expense-entry");
            }
            else
            {
                errorMessage = "Failed to save expense.";
                NotificationService.ShowError(errorMessage);
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            NotificationService.ShowError(errorMessage);
        }

        isSubmitting = false;
    }

    private void Cancel() => Navigation.NavigateTo("/transactions/expense-entry");
}
