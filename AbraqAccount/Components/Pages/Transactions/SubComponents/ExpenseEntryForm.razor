@using AbraqAccount.Models
@using AbraqAccount.Services.Interfaces
@inject IExpensesIncurredService ExpenseService
@inject NavigationManager Navigation
@inject INotificationService NotificationService

<div class="expense-entry-container px-4 py-4 mt-3">
    <!-- Header with Breadcrumbs and Top Actions -->
    <div class="row align-items-center mb-5">
        <div class="col">
            <h3 class="m-0 fw-800 text-primary" style="letter-spacing: -0.02em;">Expense Entry <small class="text-muted fw-normal ms-2" style="font-size: 0.5em; text-transform: uppercase;">Control Panel</small></h3>
        </div>
        <div class="col-auto d-flex align-items-center gap-3">
            <span class="text-muted small fw-600"><i class="bi bi-house-door me-1"></i> Home &nbsp;>&nbsp; Expense Entry</span>
            @if (!IsReadOnly)
            {
                <button class="btn btn-modern-save px-4 py-2" @onclick="SubmitForm" disabled="@isSubmitting">
                    @if (isSubmitting) { <span class="spinner-border spinner-border-sm me-2"></span> }
                    <i class="bi bi-save2-fill me-2"></i> Save Changes
                </button>
            }
            <button class="btn btn-modern-back p-2" @onclick="Cancel" title="Back"><i class="bi bi-arrow-left fs-5"></i></button>
        </div>
    </div>

    <!-- Main Form Section -->
    <fieldset disabled="@IsReadOnly">
        <div class="card shadow-sm border-0 mb-5 modern-card">
            <div class="card-header modern-header py-3 px-4">
                <h5 class="mb-0 fw-700">Basic Information <small class="text-muted fw-normal ms-2">â€” @(IsReadOnly ? "View Mode" : (IsEdit ? "Update Entry" : "New Entry"))</small></h5>
            </div>
            <div class="card-body p-4 p-lg-5">
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger border-0 shadow-sm py-3 px-4 mb-4" style="font-size: 0.9rem; border-radius: 12px;">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> @errorMessage
                    </div>
                }

                <div class="row g-4 mb-3">
                    <div class="col-md-6">
                        <label class="form-label-modern">Received Date <span class="text-danger">*</span></label>
                        <input type="date" @bind="model.ExpenseDate" class="form-control-modern" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label-modern">Credit Account <span class="text-danger">*</span></label>
                        <AbraqAccount.Components.Common.AccountSearch 
                            Placeholder="Search Credit Account" 
                            SearchFunc='@((s) => ExpenseService.GetAccountsAsync(s, "Credit"))'
                            OnAccountSelected="OnVendorSelected"
                            InitialValue="@model.VendorName"
                            CssClass="form-control-modern" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label-modern">Debit Account <span class="text-danger">*</span></label>
                        <AbraqAccount.Components.Common.AccountSearch 
                            Placeholder="Search Debit Account" 
                            SearchFunc='@((s) => ExpenseService.GetAccountsAsync(s, "Debit"))'
                            OnAccountSelected="OnDebitAccountSelected"
                            InitialValue="@model.DebitAccountName"
                            CssClass="form-control-modern" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label-modern">Unit <span class="text-danger">*</span></label>
                        <select @bind="model.Unit" class="form-control-modern">
                            <option value="">SELECT UNIT</option>
                            @foreach (var unit in unitList)
                            {
                                <option value="@unit">@unit</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label-modern">PO Type <span class="text-danger">*</span></label>
                        <select @bind="model.POType" class="form-control-modern">
                            <option value="">SELECT</option>
                            <option value="PO">PO</option>
                            <option value="Non-PO">Non-PO</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label-modern">Bill Date <span class="text-danger">*</span></label>
                        <input type="date" @bind="model.BillDate" class="form-control-modern" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label-modern">Bill No <span class="text-danger">*</span></label>
                        <input type="text" @bind="model.BillNo" class="form-control-modern" placeholder="Ref/Bill No" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label-modern">Vehicle No <span class="text-danger">*</span></label>
                        <select @bind="model.VehicleNo" class="form-control-modern">
                            <option value="">SELECT VEHICLE</option>
                            @foreach (var vehicle in vehicleList)
                            {
                                <option value="@vehicle.VehNo">@vehicle.VehNo @(string.IsNullOrEmpty(vehicle.DriverName) ? "" : $"({vehicle.DriverName})")</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label-modern">PAN No</label>
                        <input type="text" @bind="model.PANNo" class="form-control-modern" placeholder="PAN No" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label-modern">Firm Type</label>
                        <input type="text" @bind="model.FirmType" class="form-control-modern" placeholder="Firm Type" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label-modern">Expense ledger <span class="text-danger">*</span></label>
                        <AbraqAccount.Components.Common.AccountSearch 
                            Placeholder="Search Ledger" 
                            SearchFunc="@((s) => ExpenseService.GetExpenseLedgersAsync(null, s))"
                            OnAccountSelected="OnLedgerSelected"
                            InitialValue="@model.ExpenseLedger?.Name"
                            CssClass="form-control-modern" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label-modern">Bill File</label>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-outline-secondary btn-xs-modern" type="button" @onclick="() => {}">Upload</button>
                            <span class="text-muted x-small">None</span>
                        </div>
                    </div>

                    <div class="col-12 mt-2">
                        <label class="form-label-modern">Remarks</label>
                        <input @bind="model.Remarks" class="form-control-modern" placeholder="Short Remarks (Optional)" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Items Section -->
        <div class="card shadow-sm border-0 mb-3 modern-card">
            <div class="card-header modern-header py-2 px-3 d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold">Items</h6>
            </div>
            <div class="card-body p-3">
                @if (!IsReadOnly)
                {
                    <div class="modern-input-row mb-3">
                        <div class="row g-2">
                            <div class="col-lg-3 col-md-6">
                                <label class="form-label-modern">Item Group <span class="text-danger">*</span></label>
                                <AbraqAccount.Components.Common.AccountSearch 
                                    Placeholder="Group" 
                                    SearchFunc="ExpenseService.GetItemGroupsAsync"
                                    OnAccountSelected="OnNewItemGroupSelected"
                                    InitialValue="@newItem.ItemGroup?.Name"
                                    CssClass="form-control-modern" />
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <label class="form-label-modern">Item Name <span class="text-danger">*</span></label>
                                <AbraqAccount.Components.Common.AccountSearch 
                                    Placeholder="Item" 
                                    SearchFunc="@((s) => ExpenseService.GetItemNamesAsync(newItem.ItemGroupId, s))"
                                    OnAccountSelected="OnNewItemNameSelected"
                                    InitialValue="@newItem.Item?.ItemName"
                                    CssClass="form-control-modern" />
                            </div>
                            <div class="col-lg-4 col-md-8">
                                <label class="form-label-modern">Description</label>
                                <input type="text" @bind="newItem.Description" class="form-control-modern" placeholder="Description" />
                            </div>
                            <div class="col-lg-2 col-md-4">
                                <label class="form-label-modern">UOM</label>
                                <input type="text" @bind="newItem.UOM" class="form-control-modern bg-light" readonly />
                            </div>

                            <div class="col-lg-1 col-md-2 col-4">
                                <label class="form-label-modern">Qty</label>
                                <input type="number" @bind="newItem.Qty" @oninput="(e) => UpdateNewItem(e, 'Q')" class="form-control-modern text-end" />
                            </div>
                            <div class="col-lg-2 col-md-3 col-4">
                                <label class="form-label-modern">Unit Price</label>
                                <input type="number" @bind="newItem.UnitPrice" @oninput="(e) => UpdateNewItem(e, 'P')" class="form-control-modern text-end" />
                            </div>
                            <div class="col-lg-2 col-md-3 col-4">
                                <label class="form-label-modern">Amount</label>
                                <input type="number" @bind="newItem.Amount" class="form-control-modern text-end bg-light" readonly />
                            </div>
                            <div class="col-lg-1 col-md-2 col-4">
                                <label class="form-label-modern">Disc.</label>
                                <input type="number" @bind="newItem.Discount" @oninput="(e) => UpdateNewItem(e, 'D')" class="form-control-modern text-end" />
                            </div>
                            <div class="col-lg-1 col-md-2 col-4">
                                <label class="form-label-modern">GST%</label>
                                <select value="@newItem.GST" @onchange='@((e) => { newItem.GST = e.Value?.ToString() ?? "NA"; UpdateNewItemCalculations(); })' class="form-control-modern p-1">
                                    <option value="NA">NA</option>
                                    <option value="5%">5%</option>
                                    <option value="12%">12%</option>
                                    <option value="18%">18%</option>
                                    <option value="28%">28%</option>
                                </select>
                            </div>
                            <div class="col-lg-2 col-md-3 col-4">
                                <label class="form-label-modern">GST Amt</label>
                                <input type="number" @bind="newItem.GSTAmount" class="form-control-modern text-end bg-light" readonly />
                            </div>
                            <div class="col-lg-2 col-md-4 col-12 d-flex align-items-end gap-1">
                                <button class="btn btn-modern-add w-100" @onclick="AddNewItemRow"><i class="bi bi-plus-lg"></i> Add</button>
                                <button class="btn btn-modern-cancel w-100" @onclick="ClearNewItem">Clear</button>
                            </div>
                        </div>
                    </div>
                }

                <div class="table-responsive">
                    <table class="table table-custom border">
                        <thead>
                            <tr>
                                <th>Item Group</th>
                                <th>Item Name</th>
                                <th class="text-end">Qty</th>
                                <th class="text-end">Unit Price</th>
                                <th class="text-end">Amount</th>
                                <th class="text-end">Total Amount</th>
                                @if (!IsReadOnly) { <th class="text-center">Action</th> }
                            </tr>
                        </thead>
                        <tbody>
                            @if (!model.Items.Any())
                            {
                                <tr><td colspan="@(IsReadOnly ? 6 : 7)" class="text-center py-4 text-danger fw-bold">No Items found!!</td></tr>
                            }
                            else
                            {
                                @foreach (var item in model.Items)
                                {
                                    <tr>
                                        <td>@item.ItemGroup?.Name</td>
                                        <td>@item.Item?.ItemName</td>
                                        <td class="text-end">@item.Qty</td>
                                        <td class="text-end">@item.UnitPrice.ToString("N3")</td>
                                        <td class="text-end">@item.Amount.ToString("N3")</td>
                                        <td class="text-end">@item.TotalAmount.ToString("N3")</td>
                                        @if (!IsReadOnly)
                                        {
                                            <td class="text-center">
                                                <button class="btn btn-link text-danger p-0" title="Delete" @onclick="() => model.Items.Remove(item)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        }
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Misc Charges Section -->
        <div class="card shadow-sm border-0 mb-3 modern-card">
            <div class="card-header modern-header py-2 px-3">
                <h6 class="mb-0 fw-bold">Miscellaneous Charges</h6>
            </div>
            <div class="card-body p-3">
                @if (!IsReadOnly)
                {
                    <div class="modern-input-row mb-3">
                        <div class="row g-2">
                            <div class="col-lg-4 col-md-6">
                                <label class="form-label-modern">Expense Type <span class="text-danger">*</span></label>
                                <input type="text" @bind="newMisc.ExpenseType" class="form-control-modern" placeholder="e.g. Freight, Packing" />
                            </div>
                            <div class="col-lg-3 col-md-3 col-6">
                                <label class="form-label-modern">Amount <span class="text-danger">*</span></label>
                                <input type="number" @bind="newMisc.Amount" @oninput="(e) => UpdateNewMisc(e, 'A')" class="form-control-modern text-end" />
                            </div>
                            <div class="col-lg-2 col-md-3 col-6">
                                <label class="form-label-modern">Tax(%)</label>
                                <select value="@newMisc.Tax" @onchange='@((e) => { newMisc.Tax = e.Value?.ToString() ?? "Select"; UpdateNewMiscCalculations(); })' class="form-control-modern">
                                    <option value="Select">Select</option>
                                    <option value="5%">5%</option>
                                    <option value="12%">12%</option>
                                    <option value="18%">18%</option>
                                    <option value="28%">28%</option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-12 d-flex align-items-end gap-1">
                                <button class="btn btn-modern-add w-100" @onclick="AddNewMiscRow"><i class="bi bi-plus-lg"></i> Add</button>
                                <button class="btn btn-modern-cancel w-100" @onclick="ClearNewMisc">Clear</button>
                            </div>
                        </div>
                    </div>
                }

                <div class="table-responsive">
                    <table class="table table-custom border">
                        <thead>
                            <tr>
                                <th>Expense Type</th>
                                <th class="text-end">Amount</th>
                                <th class="text-center">GST(%)</th>
                                <th class="text-end">GST Amount</th>
                                <th class="text-end">Total Amount</th>
                                @if (!IsReadOnly) { <th class="text-center">Action</th> }
                            </tr>
                        </thead>
                        <tbody>
                            @if (!model.MiscCharges.Any())
                            {
                                <tr><td colspan="@(IsReadOnly ? 5 : 6)" class="text-center py-4 text-danger fw-bold">No Miscellaneous Charges found!!</td></tr>
                            }
                            else
                            {
                                @foreach (var m in model.MiscCharges)
                                {
                                    <tr>
                                        <td>@m.ExpenseType</td>
                                        <td class="text-end">@m.Amount.ToString("N3")</td>
                                        <td class="text-center">@m.Tax</td>
                                        <td class="text-end">@m.GSTAmount.ToString("N3")</td>
                                        <td class="text-end">@m.TotalAmount.ToString("N3")</td>
                                        @if (!IsReadOnly)
                                        {
                                            <td class="text-center">
                                                <button class="btn btn-link text-danger p-0" title="Delete" @onclick="() => model.MiscCharges.Remove(m)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        }
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </fieldset>

    <!-- Sticky Totals Footer -->
    <div class="sticky-footer shadow">
        <div class="row align-items-center g-3">
            <div class="col-lg-3 col-md-6">
                <div class="total-box">
                    <span class="label">Gross Total</span>
                    <span class="value">@GrossAmount.ToString("N3")</span>
                </div>
            </div>
            <div class="col-lg-2 col-md-6">
                 <div class="total-box">
                    <span class="label">Discount</span>
                    <input type="number" @bind="model.TotalDiscount" @oninput="() => RecalculateTotals()" class="discount-input" readonly="@IsReadOnly" />
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                 <div class="total-box net-total">
                    <span class="label">Net Total</span>
                    <span class="value">@TotalAmount.ToString("N3")</span>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 d-flex justify-content-end gap-2">
                @if (!IsReadOnly)
                {
                    <button class="btn btn-modern-save px-4" @onclick="SubmitForm" disabled="@isSubmitting">
                        @if (isSubmitting) { <span class="spinner-border spinner-border-sm me-2"></span> }
                        <i class="bi bi-check-circle me-1"></i> Save Entry
                    </button>
                }
                <button class="btn btn-modern-back px-4" @onclick="Cancel">
                    <i class="bi @(IsReadOnly ? "bi-arrow-left" : "bi-x-circle") me-1"></i>
                    @(IsReadOnly ? "Back to List" : "Cancel")
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .expense-entry-container { background: #f8fafc; padding: 20px; padding-bottom: 120px; font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    
    .modern-card { border-radius: 12px; border: 1px solid var(--border-color); background: #ffffff; box-shadow: var(--shadow-md) !important; margin-bottom: 24px; }
    .modern-header { background: #ffffff; border-bottom: 1px solid var(--border-color); padding: 12px 20px; background: #fcfdfe; }
    .modern-header h6 { color: var(--text-primary); letter-spacing: -0.01em; font-size: 0.95rem; }

    .form-label-modern { display: block; font-size: 0.7rem; font-weight: 800; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; }
    .form-control-modern { border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 14px; font-size: 0.875rem; width: 100%; transition: all 0.2s; background-color: #fcfdfe; }
    .form-control-modern:focus { border-color: var(--accent); outline: none; background-color: #fff; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
    .form-control-modern[readonly] { background-color: #f1f5f9; cursor: not-allowed; color: var(--text-secondary); }

    .modern-input-row { background: #f8fafc; padding: 16px; border: 1px solid var(--border-color); border-radius: 10px; }

    .btn-xs-modern { padding: 4px 10px; font-size: 0.75rem; border-radius: 6px; font-weight: 600; }
    .x-small { font-size: 0.7rem; color: var(--text-secondary); }

    .table-custom thead th { background: #f8fafc; color: var(--text-secondary); font-size: 0.7rem; text-transform: uppercase; font-weight: 800; padding: 14px 12px; border-bottom: 2px solid var(--border-color); }
    .table-custom tbody td { padding: 12px; font-size: 0.875rem; vertical-align: middle; color: var(--text-primary); border-bottom: 1px solid var(--border-color); }
    .table-custom tbody tr:hover { background-color: #f1f5f9; }

    .sticky-footer { position: fixed; bottom: 0; left: var(--sidebar-width); right: 0; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); padding: 16px 30px; border-top: 1px solid var(--border-color); z-index: 900; box-shadow: 0 -4px 15px rgba(0,0,0,0.05); }
    /* Mobile adjustment */
    @@media (max-width: 991.98px) { .sticky-footer { left: 0; } }

    .total-box { display: flex; flex-direction: column; background: #fff; padding: 10px 16px; border: 1px solid var(--border-color); border-radius: 10px; transition: all 0.3s; }
    .total-box:hover { border-color: var(--accent); transform: translateY(-2px); }
    .total-box .label { font-size: 0.65rem; font-weight: 800; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
    .total-box .value { font-size: 1.25rem; font-weight: 800; color: var(--text-primary); }
    
    .net-total { background: #eef2ff; border-color: #c7d2fe; }
    .net-total .label { color: #4f46e5; }
    .net-total .value { color: #3730a3; }

    .discount-input { border: none; background: transparent; font-size: 1.25rem; font-weight: 800; color: #ef4444; text-align: right; width: 100%; outline: none; }
    .discount-input:focus { color: #dc2626; }

    .btn-modern-add { background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 0.875rem; transition: all 0.2s; padding: 10px; }
    .btn-modern-add:hover { background: #059669; transform: scale(1.02); }
    .btn-modern-cancel { background: #fff; color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 8px; font-weight: 600; font-size: 0.875rem; padding: 10px; }
    
    .btn-modern-save { background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 1rem; transition: all 0.2s; }
    .btn-modern-save:hover { background: var(--accent-hover); box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.4); transform: translateY(-2px); }
    .btn-modern-back { background: #fff; color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 8px; font-weight: 700; font-size: 1rem; transition: all 0.2s; }
    .btn-modern-back:hover { background: #f8fafc; border-color: var(--text-secondary); }

    .col-lg-2 { width: 16.666667%; } /* Ensure precise mapping for large screens */

    @@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .modern-card { animation: fadeIn 0.5s ease-out; }
</style>

@code {
    [Parameter] public int? Id { get; set; }
    [Parameter] public bool IsReadOnly { get; set; }
    private ExpensesIncurred model = new() { ExpenseDate = DateTime.Now, BillDate = DateTime.Now };
    private ExpenseItem newItem = new() { CreatedAt = DateTime.Now, GST = "NA" };
    private ExpenseMiscCharge newMisc = new() { CreatedAt = DateTime.Now, Tax = "Select" };
    
    // Data lists
    private List<string> unitList = new() { "Unit 1", "Unit 2", "Abraq Agro Fresh LLP" };
    private List<VehInfo> vehicleList = new();

    private bool IsEdit => Id.HasValue;
    private bool isSubmitting;
    private string? errorMessage;

    private decimal GrossAmount => model.Items.Sum(i => i.TotalAmount) + model.MiscCharges.Sum(m => m.TotalAmount);
    private decimal TotalAmount => GrossAmount - model.TotalDiscount;

    protected override async Task OnInitializedAsync()
    {
        vehicleList = (await ExpenseService.GetVehiclesListAsync()).ToList();

        if (IsEdit)
        {
            var exp = await ExpenseService.GetExpenseByIdAsync(Id!.Value, true, true);
            if (exp != null) model = exp;
            else Navigation.NavigateTo("/transactions/expense-entry");
        }
    }

    // Handlers for Basic Info
    private void OnLedgerSelected(LookupItem lookup)
    {
        model.ExpenseLedgerId = lookup.Id;
        model.ExpenseLedger = new SubGroupLedger { Id = lookup.Id, Name = lookup.Name };
    }

    private void OnDebitAccountSelected(LookupItem lookup)
    {
        model.DebitAccountId = lookup.Id;
        model.DebitAccountName = lookup.Name;
    }

    private void OnVendorSelected(LookupItem lookup)
    {
        model.VendorId = lookup.Id;
        model.VendorName = lookup.Name;
    }

    // New Item logic
    private void OnNewItemGroupSelected(LookupItem lookup)
    {
        newItem.ItemGroupId = lookup.Id;
        newItem.ItemGroup = new PurchaseItemGroup { Id = lookup.Id, Name = lookup.Name };
    }

    private void OnNewItemNameSelected(LookupItem lookup)
    {
        newItem.ItemId = lookup.Id;
        newItem.Item = new PurchaseItem { Id = lookup.Id, ItemName = lookup.Name, UOM = lookup.UOM ?? "" };
        newItem.UOM = lookup.UOM ?? "";
    }

    private void UpdateNewItem(ChangeEventArgs e, char field)
    {
        if (decimal.TryParse(e.Value?.ToString(), out decimal val))
        {
            if (field == 'Q') newItem.Qty = val;
            else if (field == 'P') newItem.UnitPrice = val;
            else if (field == 'D') newItem.Discount = val;
            UpdateNewItemCalculations();
        }
    }

    private void UpdateNewItemCalculations()
    {
        newItem.Amount = newItem.Qty * newItem.UnitPrice;
        newItem.GSTAmount = CalculateTax(newItem.Amount - newItem.Discount, newItem.GST);
        newItem.TotalAmount = newItem.Amount - newItem.Discount + newItem.GSTAmount;
    }

    private void AddNewItemRow()
    {
        if (newItem.ItemId == 0 || newItem.Qty <= 0)
        {
            errorMessage = "Please select an item and enter quantity.";
            return;
        }
        model.Items.Add(newItem);
        ClearNewItem();
        errorMessage = null;
        RecalculateTotals();
    }

    private void ClearNewItem()
    {
        newItem = new ExpenseItem { CreatedAt = DateTime.Now, GST = "NA" };
    }

    // New Misc Charge logic
    private void UpdateNewMisc(ChangeEventArgs e, char field)
    {
        if (decimal.TryParse(e.Value?.ToString(), out decimal val))
        {
            if (field == 'A') newMisc.Amount = val;
            UpdateNewMiscCalculations();
        }
    }

    private void UpdateNewMiscCalculations()
    {
        newMisc.GSTAmount = CalculateTax(newMisc.Amount, newMisc.Tax);
        newMisc.TotalAmount = newMisc.Amount + newMisc.GSTAmount;
    }

    private void AddNewMiscRow()
    {
        if (string.IsNullOrEmpty(newMisc.ExpenseType) || newMisc.Amount <= 0)
        {
            errorMessage = "Please enter expense type and amount.";
            return;
        }
        model.MiscCharges.Add(newMisc);
        ClearNewMisc();
        errorMessage = null;
        RecalculateTotals();
    }

    private void ClearNewMisc()
    {
        newMisc = new ExpenseMiscCharge { CreatedAt = DateTime.Now, Tax = "Select" };
    }

    private decimal CalculateTax(decimal amount, string gst)
    {
        if (string.IsNullOrEmpty(gst) || gst == "NA" || gst == "Select") return 0;
        if (decimal.TryParse(gst.Replace("%", ""), out decimal rate))
        {
            return amount * (rate / 100);
        }
        return 0;
    }

    private void RecalculateTotals()
    {
        model.Amount = TotalAmount;
        StateHasChanged();
    }

    private async Task SubmitForm()
    {
        if (!model.ExpenseLedgerId.HasValue) { errorMessage = "Expense Ledger is required."; return; }
        if (!model.DebitAccountId.HasValue) { errorMessage = "Debit Account is required."; return; }
        if (model.VendorId == null) { errorMessage = "Credit Account is required."; return; }

        isSubmitting = true;
        errorMessage = null;

        model.Amount = TotalAmount;

        try
        {
            ExpensesIncurred result;
            if (IsEdit) result = await ExpenseService.UpdateExpenseAsync(Id!.Value, model);
            else result = await ExpenseService.CreateExpenseAsync(model);

            if (result != null)
            {
                NotificationService.ShowSuccess("Expense Entry saved successfully!");
                Navigation.NavigateTo("/transactions/expense-entry");
            }
            else
            {
                errorMessage = "Failed to save expense.";
                NotificationService.ShowError(errorMessage);
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            NotificationService.ShowError(errorMessage);
        }

        isSubmitting = false;
    }

    private void Cancel() => Navigation.NavigateTo("/transactions/expense-entry");
}
