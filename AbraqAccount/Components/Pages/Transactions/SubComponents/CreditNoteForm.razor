@using AbraqAccount.Models
@using AbraqAccount.Services.Interfaces
@using Microsoft.AspNetCore.Components.Forms
@inject ICreditNoteService CreditNoteService
@inject NavigationManager Navigation

<div class="form-container">
    <div class="form-section-title">
        Credit Note - @(IsReadOnly ? "Details" : (IsEdit ? "Edit" : "Add"))
    </div>

    <EditForm Model="model" OnValidSubmit="SubmitForm">
        <DataAnnotationsValidator />
        
    <!-- Header Fields -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="form-group-custom">
                <label class="form-label text-muted">Credit Note Date</label>
                @if (IsReadOnly)
                {
                    <div class="fw-bold fs-6">@model.CreditNoteDate.ToString("dd/MM/yyyy")</div>
                }
                else
                {
                    <input type="date" @bind="model.CreditNoteDate" class="form-control-custom" />
                }
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group-custom">
                <label class="form-label text-muted">Entry For</label>
                @if (IsReadOnly)
                {
                    <div class="fw-bold fs-6">@model.EntryForName</div>
                }
                else
                {
                    <select @onchange="OnProfileChanged" class="form-control-custom">
                        <option value="">Select Entry For</option>
                        @if (entryProfiles != null)
                        {
                            @foreach (var profile in entryProfiles)
                            {
                                <option value="@profile.Id" selected="@(selectedProfileId == profile.Id)">@profile.Name</option>
                            }
                        }
                    </select>
                }
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group-custom">
                <label class="form-label text-muted">Unit</label>
                @if (IsReadOnly)
                {
                    <div class="fw-bold fs-6">@model.Unit</div>
                }
                else
                {
                    <select @bind="model.Unit" class="form-control-custom">
                        <option value="">Select</option>
                        @foreach (var unit in unitList)
                        {
                            <option value="@unit">@unit</option>
                        }
                    </select>
                }
            </div>
        </div>
    </div>

    <!-- Transaction Details Section -->
    <div class="transaction-details-section">
        <div class="section-subtitle mb-3">Transaction Details</div>

        <div class="row mb-3">
            <div class="col-md-4">
                <div class="form-group-custom">
                    <label class="form-label text-muted">Grower Credit <span class="text-danger">*</span></label>
                    @if (IsReadOnly)
                    {
                        <div class="fw-bold fs-6">@model.CreditAccountName</div>
                    }
                    else
                    {
                        <AbraqAccount.Components.Common.AccountSearch 
                            Placeholder="Search Account Name" 
                            SearchFunc='async (t) => await SearchAccounts(t, "Credit")'
                            OnAccountSelected="(acc) => OnAccountSelected(acc, true)"
                            InitialValue="@model.CreditAccountName"
                            Disabled="@(selectedProfileId == null || selectedProfileId == 0)"
                            CssClass="form-control-custom" />
                    }
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group-custom">
                    <label class="form-label text-muted">Grower Debit <span class="text-danger">*</span></label>
                    @if (IsReadOnly)
                    {
                        <div class="fw-bold fs-6">@model.DebitAccountName</div>
                    }
                    else
                    {
                        <AbraqAccount.Components.Common.AccountSearch 
                            Placeholder="Search Account Name" 
                            SearchFunc='async (t) => await SearchAccounts(t, "Debit")'
                            OnAccountSelected="(acc) => OnAccountSelected(acc, false)"
                            InitialValue="@model.DebitAccountName"
                            Disabled="@(selectedProfileId == null || selectedProfileId == 0)"
                            CssClass="form-control-custom" />
                    }
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group-custom">
                    <label class="form-label text-muted">Amount <span class="text-danger">*</span></label>
                    @if (IsReadOnly)
                    {
                        <div class="fw-bold fs-6 text-primary">@model.Amount?.ToString("N2")</div>
                    }
                    else
                    {
                        <input type="number" step="0.01" @bind="model.Amount" class="form-control-custom" placeholder="Enter Amount" />
                    }
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="form-group-custom">
                    <label class="form-label text-muted">Narration</label>
                    @if (IsReadOnly)
                    {
                        <div class="fw-bold fs-6">@(string.IsNullOrEmpty(model.Remarks) ? "-" : model.Remarks)</div>
                    }
                    else
                    {
                        <textarea @bind="model.Remarks" class="form-control-custom" rows="2" placeholder="Enter Narration"></textarea>
                    }
                </div>
            </div>
        </div>

        @if (!IsReadOnly)
        {
        <div class="d-flex justify-content-end mb-4">
            <button type="button" class="btn-clear-custom" @onclick="ClearForm">Clear</button>
        </div>
        }
    </div>

        <div class="form-footer-actions">
            @if (!IsReadOnly)
            {
                <button type="button" class="btn-save-custom" @onclick="SubmitForm" disabled="@isSubmitting">
                    @if (isSubmitting) { <span class="spinner-border spinner-border-sm me-1"></span> }
                    Save
                </button>
                <button type="button" class="btn-cancel-custom" @onclick="Cancel">Cancel</button>
            }
            else
            {
                <a href="transactions/entries?noteType=Credit" class="btn-cancel-custom text-decoration-none d-inline-flex align-items-center">
                    <i class="bi bi-arrow-left me-1"></i> Back to List
                </a>
            }
        </div>
    </EditForm>
</div>

<style>
    .form-container.modern-card {
        background: white;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-md) !important;
    }
    
    .form-label-modern {
        display: block;
        font-size: 0.7rem;
        font-weight: 800;
        color: var(--text-secondary);
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .form-control-modern {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 0.85rem;
        width: 100%;
        transition: all 0.2s;
        background-color: #fcfdfe;
    }
    
    .form-control-modern:focus {
        border-color: var(--accent);
        outline: none;
        background-color: #fff;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .btn-modern-save { 
        background: var(--accent); 
        color: white; 
        border: none; 
        border-radius: 8px; 
        font-weight: 700; 
        font-size: 0.9rem; 
        transition: all 0.2s; 
    }
    .btn-modern-save:hover { 
        background: var(--accent-hover); 
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2); 
        transform: translateY(-1px); 
    }
    
    .btn-modern-back, .btn-modern-cancel { 
        background: #fff; 
        color: var(--text-secondary); 
        border: 1px solid var(--border-color); 
        border-radius: 8px; 
        font-weight: 600; 
        font-size: 0.9rem; 
        padding: 8px 16px;
        transition: all 0.2s; 
    }
    .btn-modern-back:hover, .btn-modern-cancel:hover { 
        background: #f8fafc; 
        border-color: var(--text-secondary); 
    }

    .form-group-custom {
        margin-bottom: 0.75rem;
    }
    .section-subtitle {
        font-size: 1rem;
        font-weight: 600;
        color: #444;
        border-bottom: 1px solid #eee;
        padding-bottom: 0.5rem;
    }
</style>

@code {
    [Parameter] public int? Id { get; set; }
    [Parameter] public string? CreditNoteNo { get; set; }
    [Parameter] public bool IsReadOnly { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }
    private CreditNote model = new() { CreditNoteDate = DateTime.Now, Unit = "UNIT-1" };
    private bool IsEdit => Id.HasValue;
    private bool isSubmitting;
    private string? errorMessage;
    private IEnumerable<LookupItem>? entryProfiles;
    private int? selectedProfileId;

    private List<string> unitList = new();

    protected override async Task OnInitializedAsync()
    {
        unitList = (await CreditNoteService.GetUnitNamesAsync()).ToList();
        entryProfiles = await CreditNoteService.GetEntryProfilesAsync();
        
        if (IsEdit)
        {
            var existing = await CreditNoteService.GetCreditNoteByIdAsync(Id!.Value);
            if (existing != null)
            {
                model = existing;
                selectedProfileId = model.EntryForId;
            }
            else
            {
                errorMessage = "Credit Note not found.";
            }
        }
    }

    private async Task<IEnumerable<LookupItem>> SearchAccounts(string term, string side)
    {
        Console.WriteLine($"[CreditNoteForm] SearchAccounts called with Term='{term}', Side='{side}'");
        var results = await CreditNoteService.GetAccountsAsync(term, selectedProfileId, side);
        Console.WriteLine($"[CreditNoteForm] Service returned {results?.Count() ?? 0} results.");
        return results;
    }

    private void OnAccountSelected(LookupItem account, bool isCredit)
    {
        if (isCredit)
        {
            model.CreditAccountId = account.Id;
            model.CreditAccountType = account.Type ?? "SubGroupLedger";
            model.CreditAccountName = account.Name;
        }
        else
        {
            model.DebitAccountId = account.Id;
            model.DebitAccountType = account.Type ?? "SubGroupLedger";
            model.DebitAccountName = account.Name;
        }
    }

    private void OnProfileChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int profileId))
        {
            selectedProfileId = profileId;
            model.EntryForId = profileId;
            model.EntryForName = entryProfiles?.FirstOrDefault(p => p.Id == profileId)?.Name;
        }
        else
        {
            selectedProfileId = null;
            model.EntryForId = null;
            model.EntryForName = null;
        }
    }

    public async Task SubmitForm()
    {
        if (model.CreditAccountId == 0 || model.DebitAccountId == 0)
        {
            errorMessage = "Please select both Credit and Debit accounts.";
            return;
        }

        isSubmitting = true;
        errorMessage = null;

        var result = IsEdit 
            ? await CreditNoteService.UpdateCreditNoteAsync(model)
            : await CreditNoteService.CreateCreditNoteAsync(model);

        if (result.success)
        {
            if (OnSaved.HasDelegate)
            {
                await OnSaved.InvokeAsync();
            }
            else
            {
                Navigation.NavigateTo("transactions/entries?noteType=Credit");
            }
        }
        else
        {
            errorMessage = result.message;
        }
        isSubmitting = false;
    }

    private void ClearForm()
    {
        model = new() { CreditNoteDate = DateTime.Now, Unit = "UNIT-1" };
        selectedProfileId = null;
        errorMessage = null;
    }

    private async Task Cancel()
    {
        if (OnSaved.HasDelegate)
        {
            await OnSaved.InvokeAsync();
        }
        else
        {
            Navigation.NavigateTo("transactions/entries?noteType=Credit");
        }
    }
}
